<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Somnath Temple Booking</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .hidden { display: none; }
        input, button { margin: 5px 0; padding: 5px; }
        #qrCode img { max-width: 200px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Somnath Temple Booking</h1>

    <!-- Login Form -->
    <div id="loginForm">
        <h2>Login</h2>
        <input type="text" id="loginPhone" placeholder="Phone"><br>
        <input type="password" id="loginPassword" placeholder="Password"><br>
        <button onclick="login()">Login</button>
        <p>Or <a href="#" onclick="showSignup()">Sign Up</a></p>
    </div>

    <!-- Signup Form -->
    <div id="signupForm" class="hidden">
        <h2>Sign Up</h2>
        <input type="text" id="signupName" placeholder="Name"><br>
        <input type="text" id="signupPhone" placeholder="Phone"><br>
        <input type="email" id="signupEmail" placeholder="Email"><br>
        <input type="password" id="signupPassword" placeholder="Password"><br>
        <button onclick="signup()">Sign Up</button>
        <p>Or <a href="#" onclick="showLogin()">Login</a></p>
    </div>

    <!-- Booking Form -->
    <div id="bookingForm" class="hidden">
        <h2>Booking Details</h2>
        <label>Date: <input type="date" id="bookingDate"></label><br>
        <label>Time: <input type="time" id="bookingTime"></label><br>
        <label>Number of People: <input type="number" id="numPeople" min="1"></label><br>
        <button onclick="generatePeopleFields()">Add People Details</button>

        <div id="peopleDetails"></div>

        <button onclick="predictCrowd()">Predict Crowd</button>
        <p id="crowdPrediction"></p>

        <button onclick="bookNow()">Book Now</button>
    </div>

    <!-- Booking Confirmation -->
    <div id="bookingConfirmation"></div>

    <script>
        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }
        function showLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function login() {
            const phone = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;

            fetch("http://127.0.0.1:5000/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone, password })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    localStorage.setItem("token", data.token);
                    alert("Login successful!");
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('bookingForm').classList.remove('hidden');
                } else alert(data.message);
            });
        }

        function signup() {
            const name = document.getElementById('signupName').value;
            const phone = document.getElementById('signupPhone').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            console.log("Signup data:", {name, phone, email, password}); // check values

            fetch("/signup", {  // use relative URL
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, phone, email, password })
        })
        .then(res => res.json())
        .then(data => {
            console.log("Signup response:", data); // check response
            alert(data.message);
            if(data.success) showLogin();
        })
        .catch(err => console.error("Signup fetch error:", err));
    }

        function generatePeopleFields() {
            const num = parseInt(document.getElementById('numPeople').value);
            const container = document.getElementById('peopleDetails');
            container.innerHTML = "";
            for(let i=1; i<=num; i++){
                container.innerHTML += `<h4>Person ${i}</h4>
                <input type="text" id="personName${i}" placeholder="Name">
                <input type="number" id="personAge${i}" placeholder="Age">
                <input type="text" id="personGender${i}" placeholder="Gender"><br>`;
            }
        }

        function predictCrowd() {
            const date = document.getElementById('bookingDate').value;
            const token = localStorage.getItem("token");

            fetch("http://127.0.0.1:5000/predict", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ date })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    document.getElementById('crowdPrediction').innerText = "Predicted Crowd: " + data.predicted_crowd;
                } else alert(data.message);
            });
        }

        function bookNow() {
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const num_people = parseInt(document.getElementById('numPeople').value);

            const people = [];
            for(let i=1; i<=num_people; i++){
                people.push({
                    name: document.getElementById(`personName${i}`).value,
                    age: parseInt(document.getElementById(`personAge${i}`).value),
                    gender: document.getElementById(`personGender${i}`).value
                });
            }

            const token = localStorage.getItem("token");

            fetch("http://127.0.0.1:5000/booking", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ date, time, num_people, people })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    document.getElementById("bookingConfirmation").innerHTML = `
                        <h3>Booking Confirmed!</h3>
                        <p>Booking ID: ${data.booking_id}</p>
                        <img src="data:image/png;base64,${data.qr_code}" alt="QR Code">
                    `;
                } else alert(data.message);
            });
        }
    </script>
</body>
</html>